/**
 * Copyright (c) 2021 Visa, Inc.
 *
 * This source code is licensed under the MIT license
 * https://github.com/visa/visa-chart-components/blob/master/LICENSE
 *
 **/
const path = require('path');
const glob = require('glob');
const fs = require('fs');

// copy counters
let successCopy = 0;
let errorCopy = 0;

// get arg passed from command line (for sibling directory)
const args = process.argv.slice(2);

// we assume the source dir is a valid dir inputted when the script is called
const sourcePath = args[0];
const destPath = path.join(__dirname, '..');

// console.log('checking source path', sourcePath, rootFolders, folders);
if (!sourcePath) {
  console.log('your source path was not provided, exiting program');
  process.exit(1);
}

// get all folders in the monorepo
const rootFolders = [
  ...glob.sync(path.join(sourcePath, '.storybook')),
  ...glob.sync(path.join(sourcePath, '.vscode')),
  ...glob.sync(path.join(sourcePath, 'docs')),
  ...glob.sync(path.join(sourcePath, 'packages')),
  ...glob.sync(path.join(sourcePath, 'scripts')),
  ...glob.sync(path.join(sourcePath, 'stories'))
];

// exclusions to apply to for autogenerated folders
const tsFileExclusions = [
  '/**/yarn.lock', // auto-generated yarn files
  '/**/yarn-*', // auto-generated yarn files
  '/**/*.d.ts', // auto-generated type files
  '/**/.stencil/**', // ensure node modules is not included
  '/**/coverage/**', // ensure node modules is not included
  '/**/dist/**', // ensure node modules is not included
  '/**/node_modules/**', // ensure node modules is not included
  '/**/www/**', // ensure node modules is not included
  '/**/charts-angular/lib/src/directives/**', // auto-generated angular directives/components
  '/**/charts-react/src/components/**', // auto-generated react components and utilities
  '/**/oss-move-files.js' // this file so that we do not cause issues with copying this
];

const folders = [];
rootFolders.forEach(folder => {
  folders.push(path.join(folder));
  fs.readdirSync(folder).forEach(subDir => {
    try {
      if (fs.lstatSync(path.join(folder, subDir)).isDirectory()) {
        // folders.push(path.join(__dirname,'..','packages', subDir));
        folders.push(path.join(folder, subDir));
        return true;
      } else {
        return false;
      }
    } catch (error) {
      return false;
    }
  });
});

console.log('checking', __dirname, destPath, sourcePath, folders);

// loop and copy
folders.forEach(folder => {
  try {
    const folderFiles = glob.sync(folder + '/**', { ignore: tsFileExclusions });
    folderFiles.forEach(fFile => {
      if (!fs.lstatSync(fFile).isDirectory()) {
        try {
          console.log('fFile', fFile, sourcePath);
          const destFile = fFile.replace(sourcePath, destPath);
          console.log('destFile', destFile, destFile);
          fs.copyFileSync(fFile, destFile);
          successCopy++;
        } catch (error) {
          errorCopy++;
          console.log('error: ', error, ' when copying', fFile, ' to ', destFile);
        }
      }
    });
  } catch (error) {
    errorCopy++;
    console.log('error: ', error, ' when copying files from', folder);
  }
});
console.log('copy script complete with ', successCopy, ' successful and ', errorCopy, ' errors.');
